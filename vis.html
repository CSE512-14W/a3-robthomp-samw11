<!DOCTYPE HTML>
<meta charset="utf-8">
<html>
<head>
<style type="text/css">  
    text {
	  font-size: 11px;
	  pointer-events: none;
	}

	text.parent {
	  fill: #1f77b4;
	}

	circle {
	  pointer-events: all;
	}

	circle.parent:hover {
	  stroke: #ff7f0e;
	  stroke-width: .5px;
	}

	circle.child {
	  pointer-events: none;
	}
	
	.d3-tip {
	  line-height: 1;
	  font-weight: bold;
	  padding: 12px;
	  background: rgba(0, 0, 0, 0.8);
	  color: #fff;
	  border-radius: 2px;
	}

	/* Creates a small triangle extender for the tooltip */
	.d3-tip:after {
	  box-sizing: border-box;
	  display: inline;
	  font-size: 10px;
	  width: 100%;
	  line-height: 1;
	  color: rgba(0, 0, 0, 0.8);
	  content: "\25BC";
	  position: absolute;
	  text-align: center;
	}

	/* Style northward tooltips differently */
	.d3-tip.n:after {
	  margin: -1px 0 0 0;
	  top: 100%;
	  left: 0;
	}
</style>
</head>
<body>
	<script src="script/d3.v3.js"></script>
	<script src="script/d3.tip.v0.6.3.js"></script>
	<script src="script/jquery-1.11.0.min.js"></script>	
	<script>
		window.onload = function() {
			max = -1;
			
			var w = 1024,
				h = 640,
				r = 600,
				x = d3.scale.linear().range([0, r]),
				y = d3.scale.linear().range([0, r]),
				node,
				rootNode;

			var bubble = d3.layout.pack()
				.sort(null)
				.size([r, r])
				.padding(1.5);

			var vis = d3.select("body").insert("svg:svg", "h2")
				.attr("width", w)
				.attr("height", h)
			  .append("svg:g")
				.attr("transform", "translate(" + (w - r) / 2 + "," + (h - r) / 2 + ")");

			var info = d3.select("body").insert("div");
			
			var tip = d3.tip()
				.attr('class', 'd3-tip')
				.offset([-10, 0])
				.html(function(d) {
					return "<strong>Artist:</strong> <span style='color:red'>" + d.artist + "</span><br />" + 
					"<strong>Songs:</strong> <span style='color:red'>" + d.songs + "</span><br />" + 
					"<strong>Avg Dur:</strong> <span style='color:red'>" + d.avgDur + "</span>";
				});

			vis.call(tip);

			//set these to specify what artists to fetch from the data
			//ranges are inclusive and (for some reason) having a zero before decimal places matters
			var yearMin = "2008";
			var yearMax = "2008";
			var famMin = "0.5";
			var famMax = "0.6";

			$.getJSON( "dataset/layer2.php", { yearMin: yearMin, yearMax: yearMax, famMin: famMin, famMax: famMax})
				.done(function( data ) {
					console.log(data);
					var c = classes(data);
			  
					var color = d3.scale.sqrt()
						.domain([0, max])
						.range(["white", "green"]);
		  
					node = rootNode = c;
					var bub = bubble.nodes(c);
					node = rootNode = bub[0];
					vis.selectAll("circle")
							.data(bub)
					.enter().append("svg:circle")
							.attr("class", function(d) { return "parent" })
							.attr("cx", function(d) { return d.x; })
							.attr("cy", function(d) { return d.y; })
							.attr("r", function(d) { return d.r; })
							.attr("fill", function(d) { return d == rootNode ? d3.rgb(200,200,200) : color(d.avgDur); })
							.on("click", function(d) { 
								console.log(d == node);
								return zoom(node == d ? rootNode : d); })
							.on('mouseover', function(d) { if (d != rootNode) {tip.show(d)}})
							.on('mouseout', function(d) { if (d != rootNode) {tip.hide(d)}});

					vis.selectAll("text")
							.data(bub)
						.enter().append("svg:text")
							.attr("class", function(d) { return d.children ? "parent" : "child"; })
							.attr("x", function(d) { return d.x; })
							.attr("y", function(d) { return d.y; })
							.attr("dy", ".35em")
							.attr("text-anchor", "middle")
							.style("opacity", function(d) { return d.r > 20 ? 1 : 0; })
							.text(function(d) { return d.artist; });

					d3.select(window).on("click", function() { zoom(rootNode); });
				});

			// Returns a flattened hierarchy containing all leaf nodes under the root.
			function classes(root) {
			 	var classes = [];

				root.forEach(function(child) { 
					if (child.totDur/child.songs > max) {
						max = child.totDur/child.songs;
					}
					classes.push({artist: child.artist, value: child.songs, songs: child.songs, totDur: child.totDur, avgDur: (child.totDur/child.songs).toFixed(1)});
				});

				return {children: classes, value: 0};
			}

			function zoom(dTop, i) {
				var k = r / dTop.r / 2;
				if (dTop != rootNode) {
					x.domain([dTop.x - 5*dTop.r, dTop.x + 5*dTop.r]);
					y.domain([dTop.y - 5*dTop.r, dTop.y + 5*dTop.r]);
				} else {
					x.domain([dTop.x - dTop.r, dTop.x + dTop.r]);
					y.domain([dTop.y - dTop.r, dTop.y + dTop.r]);
				}

				var t = vis.transition()
					.duration(d3.event.altKey ? 7500 : 750);

				t.selectAll("circle")
					.attr("cx", function(d) { return x(d.x); })
					.attr("cy", function(d) { return y(d.y); })
					.attr("r", function(d) { return dTop != rootNode ? k * d.r / 5 : k * d.r; });

				t.selectAll("text")
					.attr("x", function(d) { return x(d.x); })
					.attr("y", function(d) { return y(d.y); })
					.style("opacity", function(d) { return k * d.r > 20 ? 1 : 0; });

				node = dTop;
				d3.event.stopPropagation();

				if (dTop != rootNode) {				
					info.selectAll("p").remove();
					info.select("ul").remove();
					info.append("p").text("Loading");
					$.getJSON( "dataset/layer3.php", { artist: dTop.artist} )
						.done(function( data ) {
							data.sort(function(a,b) {
								var yc = a["year"].localeCompare(b["year"]);
								if (yc == 0) {
									return a["title"].localeCompare(b["title"]);
								}
								return yc;
							});
							info.selectAll("p").remove();
							info.append("p").text(data[0]["artist_name"] + ":");
							info.append("p").text("Total Songs: " + data.length);
							info.append("p").text("Familiarity: " + data[0]["artist_familiarity"]);
							info.append("p").text("Hotness: " + data[0]["artist_hotttnesss"]);
							info.append("ul").selectAll("li")
								.data(data)
							.enter().append("li")
								.text(function(d) { return d["year"] + " - " + d["title"] + " - " + d["duration"]; });
						});
				}
			}
		}
	</script>
</body>
<!-- Look into abbreviating the bubble labels
		Animate Go Back text along outer radius, have click outside return to 1st layer 
		Segment out script and style files
		add colors as variables to top of code
		600 duration limit now
		strip duration digits past first decimal-->
</html>